#!/bin/bash

sleep 16

declare -A CHANNELS
CHANNELS=(
  ["Luke Smith"]="https://www.youtube.com/@LukeSmithxyz/videos"
  ["Brodie Robertson"]="https://www.youtube.com/@BrodieRobertson/videos"
  ["TechOverTea"]="https://www.youtube.com/@TechOverTea/videos"
  ["Derek Taylor"]="https://www.youtube.com/@DistroTube/videos"
  ["Mental Outlaw"]="https://www.youtube.com/@MentalOutlaw/videos"
  ["Wolfgang"]="https://www.youtube.com/@WolfgangsChannel/videos"
  ["Kai Hendry"]="https://www.youtube.com/@kaihendry/videos"
  ["ChrisMachine"]="https://www.youtube.com/@chrisatmachine/videos"
  ["LinusTechTips"]="https://www.youtube.com/@LinusTechTips/videos"
  ["Jayz2Cents"]="https://www.youtube.com/@Jayztwocents/videos"
  ["Nexus"]="https://www.youtube.com/@GamersNexus/videos"
  ["HWUnboxed"]="https://www.youtube.com/@Hardwareunboxed/videos"
  ["Digital Foundry"]="https://www.youtube.com/@DigitalFoundry/videos"
  ["Great Art Explained"]="https://www.youtube.com/@GreatArtExplained/videos"
  ["The Art Assignment"]="https://www.youtube.com/@theartassignment/videos"
  ["TATE"]="https://www.youtube.com/@Tate/videos"
  ["CinemaTyler"]="https://www.youtube.com/@CinemaTyler/videos"
  ["Now You See It"]="https://www.youtube.com/@NowYouSeeIt/videos"
  ["Tyler Mowery"]="https://www.youtube.com/@TylerMowery/videos"
  ["Cinema Cartography"]="https://www.youtube.com/@TheCinemaCartography/videos"
  ["Tufan Simsekcan"]="https://www.youtube.com/@TufanSimsekcan/videos"
  ["LikeStoriesofOld"]="https://www.youtube.com/@LikeStoriesofOld/videos"
  ["Solar Sands"]="https://www.youtube.com/@SolarSands/videos"
  ["The SOL"]="https://www.youtube.com/@theschooloflifetv/videos"
  ["Wisecrack"]="https://www.youtube.com/@WisecrackEDU/videos"
  ["Escaping Ordinary"]="https://www.youtube.com/@escaping.ordinary/videos"
  ["Mike Israetel"]="https://www.youtube.com/@MikeIsraetelMakingProgress/videos"
  ["Epic History"]="https://www.youtube.com/@EpichistoryTv/videos"
  ["Smart History"]="https://www.youtube.com/@smarthistoryvideos/videos"
  ["Survive The Jive"]="https://www.youtube.com/@Survivethejive/videos"
  ["BeSmart"]="https://www.youtube.com/@besmart/videos"
  ["Veritasium"]="https://www.youtube.com/@veritasium/videos"
  ["Tom Scott"]="https://www.youtube.com/@TomScottGo/videos"
  ["Vsauce"]="https://www.youtube.com/@Vsauce/videos"
  ["Smithsonian"]="https://www.youtube.com/@SmithsonianChannel/videos"
  ["VICE"]="https://www.youtube.com/@VICE/videos"
  ["Simon Smith"]="https://www.youtube.com/@SimonSmithWhoPlaysTheGuitar/videos"
  ["LeonardLux"]="https://www.youtube.com/@LeonardoLux96/videos"
  ["Lykanthrop"]="https://www.youtube.com/@Lykanthrop/videos"
  ["Efe Aydal"]="https://www.youtube.com/@conmech/videos"
  ["ERLIK"]="https://www.youtube.com/@ERLIK61/videos"
  ["Can Sungur"]="https://www.youtube.com/@csnaber/videos"
  ["VaatiVidya"]="https://www.youtube.com/@VaatiVidya/videos"
  ["Enis Kirazoglu"]="https://www.youtube.com/@EnisKirazogluvideolar/videos"
  ["Orhun Kayaalp"]="https://www.youtube.com/@OrhunKayaalp/videos"
  ["RenaissancePer."]="https://www.youtube.com/@RenaissancePeriodization/videos"
  ["Eric Helms"]="https://www.youtube.com/@Team3DMJ/videos"
  ["MorePlatesMoreDates"]="https://www.youtube.com/@MorePlatesMoreDates/videos"
  ["Jeff Nippard"]="https://www.youtube.com/@JeffNippard/videos"
  ["Omar Isuf"]="https://www.youtube.com/@OmarIsuf/videos"
  ["Jeremy Ethier"]="https://www.youtube.com/@JeremyEthier/videos"
)

DATA_DIR="$HOME/.cache/youtube_channels"
mkdir -p "$DATA_DIR"

compare_data() {
  local channel_name="$1"
  local data_file="${DATA_DIR}/${channel_name}.tsv"
  local old_data_file="${DATA_DIR}/${channel_name}_old.tsv"

  # If old_data_file exists, then compare it with data_file
  if [[ -e $old_data_file ]]; then
    old_urls=$(cut -f2 "$old_data_file")
    new_urls=$(cut -f2 "$data_file")
    new_videos=$(comm -13 <(sort <<<"$old_urls") <(sort <<<"$new_urls") | wc -l)
    if [[ $new_videos -gt 0 ]]; then
      notify-send -u critical "$channel_name | $new_videos videos"
    fi
  fi
}

update_data() {
  local channel_name="$1"
  local channel_url="$2"
  local data_file="${DATA_DIR}/${channel_name}.tsv"
  local old_data_file="${DATA_DIR}/${channel_name}_old.tsv"

  # Store old data
  mv "$data_file" "$old_data_file" 2>/dev/null

  yt-dlp -j --flat-playlist --skip-download --extractor-args youtubetab:approximate_date "$channel_url" | jq -r '[.title, .url, .view_count, .duration, .upload_date] | @tsv' > "$data_file"
}

update_all_channels() {
  local pids=()
  for channel_name in "${!CHANNELS[@]}"; do
    update_data "$channel_name" "${CHANNELS[$channel_name]}" &
    pids+=("$!")
  done

  for pid in ${pids[*]}; do
    wait $pid
  done

  for channel_name in "${!CHANNELS[@]}"; do
    compare_data "$channel_name"
  done
}

update_all_channels
