#!/bin/sh

emerge gentoo-sources

DIR_COUNT=$(find /usr/src/ -maxdepth 1 -type d -name 'linux-*' | wc -l)
[ "$DIR_COUNT" -gt "1" ] || { echo "There is only one linux directory. The script stops..."; exit 1; }

cd "$(find /usr/src/ -maxdepth 1 -type d -name 'linux-*' | sort -rV | head -n 1)" &&

export LLVM=1 \
       LLVM_IAS=1 \
       KCFLAGS='-O3 -fomit-frame-pointer -pipe' \
       KCPPFLAGS='-O3 -fomit-frame-pointer -pipe'

cp "$(find /usr/src/ -maxdepth 1 -type d -name 'linux-*' | sort -rV | head -n 2 | tail -n 1)/.config" . &&

make olddefconfig &&

make -j$(nproc) &&

emerge nvidia-drivers &&

make modules_install &&

cp arch/x86/boot/bzImage /boot/EFI/BOOT/BOOTX64_2.EFI &&

rm -rf "$(find /usr/src/ -maxdepth 1 -type d -name 'linux-*' | sort -rV | head -n 2 | tail -n 1)"
