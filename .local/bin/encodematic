#!/bin/dash

find . -type f \( -name "*.mp4" -o -name "*.mkv" -o -name "*.webm" -o -name "*.mov" -o -name "*.m4v" -o -name "*.wmv" -o -name "*.flv" -o -name "*.avi" -o -name "*.m2ts" \) -print0 | while IFS= read -r -d '' file; do
  echo "Processing $file"
  codec=$(ffprobe -v error -select_streams v:0 -show_entries stream=codec_name -of default=noprint_wrappers=1:nokey=1 "$file")

    [ "$codec" != "hevc" && "$codec" != "h265" && "$codec" != "x265" ] &&
    echo "Converting $file"
    bitrate=$(ffprobe -v error -select_streams v:0 -show_entries stream=bit_rate -of default=noprint_wrappers=1:nokey=1 "$file")

    [ "$bitrate" == "N/A" ] &&
      bitrate=$(mediainfo "$file" | grep "Overall bit rate" | sed -E 's/[^0-9]//g')
      bitrate=$(echo "$bitrate*1000" | bc)


    bitrate=$(echo "$bitrate/1000" | bc)
    bv=$(echo "scale=0; $bitrate*0.40/1" | bc)
    maxrate=$(echo "scale=0; $bitrate*0.55/1" | bc)
    bufsize=$maxrate
    output="${file%.*}_output.mkv"

    ffmpeg -hwaccel cuda \
    -hwaccel_output_format cuda \
    -i "$file" \
    -c:v hevc_nvenc \
    -profile:v rext \
    -preset p7 \
    -tune hq \
    -tier high \
    -rc vbr \
    -b:v ${bv}k \
    -minrate 0 \
    -maxrate ${maxrate}k \
    -bufsize ${bufsize}k \
    -2pass 1 \
    -multipass 2 \
    -rc-lookahead 32 \
    -surfaces 64 \
    -c:a libopus \
    -b:a 96k \
    -spatial_aq 1 \
    -temporal_aq 1 \
    -aq-strength 15 \
    -b_ref_mode each \
    -f matroska "$output" < /dev/null
    wait
done
